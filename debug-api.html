<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .endpoint { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .response { background: #e8f5e8; padding: 10px; border-radius: 3px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .error { background: #ffe8e8; padding: 10px; border-radius: 3px; color: #d00; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>AdaKings API Debug Tool</h1>
        
        <div class="section">
            <h3>Authentication</h3>
            <input type="text" id="token" placeholder="Enter Bearer Token" />
            <button onclick="setTokenFromLocalStorage()">Use LocalStorage Token</button>
            <div id="tokenStatus"></div>
        </div>

        <div class="section">
            <h3>Test Endpoints</h3>
            
            <div class="endpoint">
                <strong>1. Transaction Table API</strong>
                <button onclick="testTransactionTable()">Test /api/payments/transaction-table/</button>
                <div id="transactionTableResult"></div>
            </div>

            <div class="endpoint">
                <strong>2. Orders API (Today)</strong>
                <button onclick="testTodayOrders()">Test /api/orders/ (today)</button>
                <div id="todayOrdersResult"></div>
            </div>

            <div class="endpoint">
                <strong>3. Generic Payments API</strong>
                <button onclick="testPaymentsAPI()">Test /api/payments/</button>
                <div id="paymentsResult"></div>
            </div>

            <div class="endpoint">
                <strong>4. API Root</strong>
                <button onclick="testAPIRoot()">Test /api/</button>
                <div id="apiRootResult"></div>
            </div>
        </div>

        <div class="section">
            <h3>Data Analysis</h3>
            <button onclick="analyzeTransactionData()">Analyze Transaction Data</button>
            <div id="analysisResult"></div>
        </div>
    </div>

    <script>
        let authToken = '';
        let transactionData = null;

        function setTokenFromLocalStorage() {
            const token = localStorage.getItem('token');
            if (token) {
                authToken = token;
                document.getElementById('token').value = token;
                document.getElementById('tokenStatus').innerHTML = '<div style="color: green;">✓ Token loaded from localStorage</div>';
            } else {
                document.getElementById('tokenStatus').innerHTML = '<div style="color: red;">✗ No token found in localStorage</div>';
            }
        }

        function updateToken() {
            authToken = document.getElementById('token').value;
        }

        document.getElementById('token').addEventListener('input', updateToken);

        async function makeAPICall(url, resultElementId) {
            const resultElement = document.getElementById(resultElementId);
            resultElement.innerHTML = '<div>Loading...</div>';

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = responseText;
                }

                const resultHtml = `
                    <div><strong>Status:</strong> ${response.status} ${response.statusText}</div>
                    <div><strong>URL:</strong> ${url}</div>
                    <div><strong>Response:</strong></div>
                    <div class="response">${JSON.stringify(data, null, 2)}</div>
                `;
                
                resultElement.innerHTML = resultHtml;
                return data;
            } catch (error) {
                resultElement.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                return null;
            }
        }

        async function testTransactionTable() {
            const data = await makeAPICall('http://localhost:8000/api/payments/transaction-table/', 'transactionTableResult');
            transactionData = data;
        }

        async function testTodayOrders() {
            const today = new Date().toISOString().split('T')[0];
            await makeAPICall(`http://localhost:8000/api/orders/?date=${today}&ordering=-updated_at`, 'todayOrdersResult');
        }

        async function testPaymentsAPI() {
            await makeAPICall('http://localhost:8000/api/payments/', 'paymentsResult');
        }

        async function testAPIRoot() {
            await makeAPICall('http://localhost:8000/api/', 'apiRootResult');
        }

        function analyzeTransactionData() {
            const resultElement = document.getElementById('analysisResult');
            
            if (!transactionData) {
                resultElement.innerHTML = '<div class="error">No transaction data available. Please test transaction table API first.</div>';
                return;
            }

            let transactions = [];
            
            // Handle different response formats
            if (Array.isArray(transactionData)) {
                transactions = transactionData;
            } else if (transactionData.transactions && Array.isArray(transactionData.transactions)) {
                transactions = transactionData.transactions;
            } else if (transactionData.data && Array.isArray(transactionData.data)) {
                transactions = transactionData.data;
            } else if (transactionData.results && Array.isArray(transactionData.results)) {
                transactions = transactionData.results;
            }

            const today = new Date().toISOString().split('T')[0];
            const todayTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.created_at || transaction.date).toISOString().split('T')[0];
                return transactionDate === today;
            });

            const todayRevenue = todayTransactions.reduce((sum, t) => {
                const isRefund = t.payment_type === 'refund' || 
                              t.payment_type === 'Refund' || 
                              t.type === 'refund' ||
                              (t.amount && parseFloat(t.amount) < 0);
                return isRefund ? sum : sum + parseFloat(t.amount || 0);
            }, 0);

            const analysis = {
                totalTransactions: transactions.length,
                todayTransactions: todayTransactions.length,
                todayRevenue: todayRevenue,
                todayDate: today,
                sampleTransaction: transactions[0] || null,
                sampleTodayTransaction: todayTransactions[0] || null,
                transactionDates: transactions.map(t => new Date(t.created_at || t.date).toISOString().split('T')[0]).slice(0, 10)
            };

            resultElement.innerHTML = `
                <div class="response">${JSON.stringify(analysis, null, 2)}</div>
            `;
        }

        // Auto-load token on page load
        window.addEventListener('load', setTokenFromLocalStorage);
    </script>
</body>
</html>
